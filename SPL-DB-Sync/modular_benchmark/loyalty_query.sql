-- SPL-DB-Sync Experiment: Modular Approach (Efficient)
-- Clean, well-structured loyalty classification using efficient JOINs
SELECT 
    C.C_NAME,
    C.C_ACCTBAL,
    AVG(O.O_TOTALPRICE) as AVG_ORDER_VALUE,
    CASE 
        WHEN AVG(O.O_TOTALPRICE) > 300000 THEN 'Platinum'
        WHEN AVG(O.O_TOTALPRICE) > 200000 THEN 'Gold'
        WHEN AVG(O.O_TOTALPRICE) > 100000 THEN 'Silver'
        ELSE 'Bronze'
    END AS LOYALTY_TIER
FROM {CUSTOMER_TABLE} C
INNER JOIN {ORDERS_TABLE} O ON C.C_CUSTKEY = O.O_CUSTKEY
GROUP BY C.C_CUSTKEY, C.C_NAME, C.C_ACCTBAL
HAVING AVG(O.O_TOTALPRICE) > 80000
ORDER BY AVG_ORDER_VALUE DESC;
